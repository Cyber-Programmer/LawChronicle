# LawChronicle Codebase Audit — 2025-08-12

This report provides a quantitative, actionable audit across backend (FastAPI + Motor/PyMongo, Pydantic, JWT) and frontend (React + TS, CRA/Tailwind). Security checks included where feasible.

## Overall health score: 62/100
- Strengths: clean API layering in core, good router structure, initial tests present, sensible typing (Pydantic models).
- Weaknesses: two monolithic endpoint modules (phase2.py, phase3.py) with low maintainability; blocking sync DB in async endpoints; security footguns (demo auth/test route, bind-all); outdated frontend deps.

## scope
- Included: backend/ (17 py files), frontend/src/ (50 ts/tsx files), shared/types/common.py.
- Excluded from strict review: frontend/build, node_modules, backend/__pycache__, references/ treated as utility scripts.
- Baselines: Python lint via Ruff; CRA eslint defaults for TS; security: Bandit; dependency: npm outdated, pip-audit attempted (permissions blocked).

## backend — metrics snapshot
- Files: 17; Total sloc ≈ 3,983.
- Cyclomatic complexity (radon): average A (4.19); hotspot function E(34) in phase2.py.
- Maintainability Index (radon): mostly A; outliers: phase2.py MI=25.12 (low), phase3.py MI=15.47 (low-B).
- TODO/FIXME markers: 6 (all in phases.py).
- Ruff lint: unused imports/vars, bare excepts, repeated dict keys, one f-string issue.
- Bandit: LOW/MED around subprocess usage and hardcoded/test credentials; bind 0.0.0.0.
- Tests (pytest): 1 failed, 7 passed, 1 skipped.

## frontend — metrics snapshot
- Files: 50 TS/TSX; structure clean (contexts/services/pages/components).
- Outdated deps: 13 (React 18→19, TypeScript 4.9→5.9, Tailwind 3→4, Router 6→7, testing libs).
- Not assessed: complexity/coverage (TS) — recommend eslint/type-check/jest in CI.

## per-file breakdown (backend)

- backend/main.py
  - LoC 69 (sloc 54), funcs 3 (A: 1–2 CC), classes 0, MI 74.63 (A), comment ratio 16.7%.
  - Risks: uvicorn bind 0.0.0.0; unused imports (Ruff). Suggest env host/port; production run via process manager.

- app/core/config.py
  - LoC 39, MI 100 (A).
  - Risks: default debug=True; default secret_key literal. Require env; default debug False.

- app/core/database.py
  - LoC 78; fns 4; MI 100 (A). Async motor, ping on startup, indexes created.
  - Notes: index creation is idempotent in MongoDB; acceptable.

- app/core/auth.py
  - LoC 69; fns 6 (all A); MI 60.41 (A).
  - Risks: symmetric secret; no user store. Works with demo login elsewhere.

- app/api/v1/api.py
  - LoC 11; MI 100 (A). Router aggregation is clean.

- app/api/v1/endpoints/auth.py
  - LoC 80; routes 4; MI 66.97 (A).
  - Risks: demo creds in env with plaintext check; /test-auth exposes hash/verification; Bandit B105-like (hardcoded password usage context).

- app/api/v1/endpoints/database.py
  - LoC 183; routes 4 (B7, A4, A3, A2); MI 59.17 (A); comment ratio ~24%.
  - Risks: N×count_documents per collection; can be heavy. Consider $collStats or cached counts.

- app/api/v1/endpoints/phase1.py
  - LoC 375; 7 routes (C16, C12, B10, others A); MI 44.31 (A); comment ratio ~27%.
  - Risks: uses sync pymongo inside async routes (event loop blocking); bare excepts (3x); repeated dict keys (2x); Ruff F401/E722/F601.

- app/api/v1/endpoints/phase2.py  ← HOTSPOT
  - LoC 1519; funcs/classes ≈ 27; execute_normalization E(34); MI 25.12 (lowest).
  - Risks: monolithic endpoint; subprocess on generated scripts; unused imports/vars; mixed concerns (endpoint + business + script codegen).

- app/api/v1/endpoints/phase3.py  ← HOTSPOT
  - LoC 1288; many funcs/classes (several C/B); MI 15.47 (low-B).
  - Risks: same monolith pattern; subprocess; bare excepts; heavy logic inside controller.

- app/api/v1/endpoints/phases.py
  - LoC 250; 10 routes (all A); MI 56.39 (A).
  - TODO markers: 6 (“Implement actual Phase X logic”).

- backend/tests/test_api_endpoints.py
  - LoC 195; MI 38.09 (A); 9 tests; 1 failing (403 on DB connect due to auth dependency not overridden).

- Other small scripts (verify_5batch.py, check_restored.py, test_*): MI A across the board.

## code quality metrics
- Cyclomatic complexity (avg): 4.19 (A). Outlier: execute_normalization() CC=34 (E) in phase2.py.
- Function length (rough): phase2/3 include 100–250+ line functions; others <50 lines.
- Comment-to-code ratio (backend overall): ~18–22% (varies per file; see raw metrics above).
- TODO/FIXME total: 6 (phases.py).

## architecture & structure
- Modularity score (1–10):
  - core/*: 8
  - api/v1/auth, database: 7
  - api/v1/phase1: 5 (sync I/O in async; mixed concerns)
  - api/v1/phase2: 3 (monolith + subprocess + script generation)
  - api/v1/phase3: 4 (monolith; mixed concerns)
  - frontend/src: 7 (contexts/services/pages/components split)
- Layer separation issues:
  - Controllers (phase2/3) include heavy business logic and script orchestration.
  - phase1 uses synchronous DB client in async handlers.
- Duplication hotspots: ObjectId conversion helpers and batch/statute normalization logic reappear across endpoints; should live in service modules.

## code smells & risks
- Performance: sync PyMongo in async routes (HIGH); repeated count_documents per collection (MED).
- Security: demo/test route in auth; default secret key; uvicorn bind-all; subprocess execution of generated scripts from HTTP path (MED; validate inputs, sandbox).
- Maintainability: oversized modules (phase2/3); bare excepts; unused imports/vars.
- Deprecated/fragile: none flagged as deprecated; large embedded script strings are fragile and hard to test.

## stylistic consistency
- Ruff flags (highlights):
  - Unused imports (F401) across main.py, phase1.py, phase2.py, phase3.py, tests.
  - Bare excepts (E722) in phase1.py, phase3.py.
  - Repeated dict keys (F601) in phase1.py.
  - Unused locals (F841) in phase2.py, batch_processor.py.
  - f-string without placeholders (F541) in phase2.py.
- Recommendation: adopt ruff format or Black + isort; add pre-commit.

## testing coverage & reliability
- Presence: backend pytest suite covers auth, database, phase1, phase2, root.
- Result: 1 failed (403 on DB connect) due to missing auth in test; 7 passed; 1 skipped.
- Estimated coverage: ~35–45% of backend routes; complex logic in phase2/3 under-tested.
- Recommendations: dependency overrides for auth in tests; unit tests for normalization/cleaning services once extracted.

## dependency health
- Backend (requirements.txt pins): older than env-installed packages; FastAPI 0.104.1, uvicorn 0.24.0, pandas 2.1.4, numpy 1.25.2.
- Python vulnerability scan: pip-audit failed locally due to pip cache permissions (Windows). Run in CI or with writable cache dir. Alternative: safety check.
- Frontend (npm outdated): 13 outdated, many major (React 19, TS 5.9, Tailwind 4, Router 7). Plan staged upgrades.

## action plan

| Issue | Priority | Suggested Fix | Est. Effort (h) | Expected Impact |
| --- | --- | --- | ---: | --- |
| phase2.py monolith; execute_normalization CC=34; MI=25 | High | Split into service modules: normalization_service.py (pure logic), script_runner.py (subprocess wrapper), thin controller; add pydantic request models & validation | 10–14 | Large (maintainability, testability, security) |
| phase3.py monolith; MI=15; subprocess + bare excepts | High | Extract SectionSplittingEngine/FieldCleaningEngine to core/services; typed exceptions; centralize metadata; isolate subprocess | 10–14 | Large |
| phase1 uses sync PyMongo in async routes | High | Migrate to motor AsyncIOMotorClient; await queries; add timeouts | 4–6 | High (performance) |
| Auth demo/test endpoints & plaintext checks | High | Remove /test-auth in non-test; env-based demo creds; hash compare; toggle via DEBUG | 1–2 | Medium (security) |
| Tests: DB connect test 403 (auth dependency) | Medium | Use FastAPI dependency_overrides for get_current_user; or login token flow in test | 1 | Medium (CI reliability) |
| Bare excepts & repeated dict keys | Medium | Replace with specific exceptions; fix dict keys; add error context | 2–3 | Medium |
| Ruff lint issues (unused imports/vars, f-string) | Medium | Apply ruff --fix; add pre-commit to enforce | 1–2 | Medium |
| Uvicorn bind-all in __main__ | Medium | Host/port via env; avoid __main__ in prod; use ASGI server config | 1 | Medium |
| Frontend major upgrades (React, TS, Tailwind) | Medium | Stage: TS 5→ React 19 → Tailwind 4; run codemods; update tests | 6–10 | Medium |
| Secrets & debug defaults in config | Medium | Default debug False; require SECRET_KEY from env; validate settings | 1–2 | Medium |
| Collection stats performance | Low | Use $collStats or cached counts; batch operations | 2–3 | Low |
| Logging verbosity in AuthContext | Low | Replace console logs with logger; guard by NODE_ENV | 0.5 | Low |

## top 5 fixes for maximum ROI
1) Refactor phase2 into service + runner + controller (expect 60%+ complexity reduction; unlock unit tests).
2) Extract phase3 engines into services, remove bare excepts, isolate subprocess calls.
3) Convert phase1 to motor (async) to eliminate event loop blocking.
4) Secure auth: remove /test-auth; env-backed creds; hashed comparisons; configurable SECRET_KEY.
5) Fix tests (dependency overrides) and enforce Ruff in pre-commit for quick quality wins.

## quality gates (current run)
- Build: not executed; imports OK; tests run locally.
- Lint (Python): Ruff flagged multiple issues (FAIL); mostly auto-fixable.
- Unit tests (backend): FAIL (1 failed, 7 passed, 1 skipped).
- Security: Bandit indicates LOW/MED issues (subprocess, demo creds); pip-audit not completed (env perms).
- Smoke: app loads for tests; endpoints reachable where mocked.

## assumptions & notes
- references/ treated as utilities; if executed via API, apply same hardening/testing.
- pip-audit failure due to Windows cache permissions — run in CI container/venv or set PIP_CACHE_DIR to a writable path.
- Frontend coverage not measured in this run; add jest/coverage to CI for tracking.

---

Prepared on 2025-08-12. Metrics sources: radon (cc, mi, raw), Ruff (lint), pytest (tests), npm outdated. Security: Bandit; pip-audit attempted.
